<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="stylesheet" href="/all_css/profile.css">
</head>
<body>
    <div class="container">
        <div class="profile-card">
            <div class="profile-header">
                <img id="avatarImg" src="/images/eb43e2e34889c891b4f6e66f44aa0dff.jpg" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar" style="cursor:pointer">
                <input id="avatarInput" type="file" accept="image/*" style="display:none" />
                <h2>–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</h2>
                <p>–ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
            </div>

            <div class="profile-info">
                <div class="info-item">
                    <label>Email:</label>
                    <span>ivan@example.com</span>
                </div>
                <div class="info-item">
                    <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
                    <span>15.03.2024</span>
                </div>
                <div class="info-item">
                    <label>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ:</label>
                    <span>15.03.2025</span>
                </div>
            </div>

            <div class="profile-actions">
                <button class="profile-btn">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                <button class="profile-btn change-pass-btn">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button class="profile-btn logout-btn">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="menu-buttons">
            <button class="menu-btn" onclick="location.href='home.html'">–ì–ª–∞–≤–Ω–∞—è üè†</button>
            <button class="menu-btn" onclick="location.href='catalog.html'">–ö–∞—Ç–∞–ª–æ–≥ üìí</button>
            <button class="menu-btn" onclick="location.href='cart.html'">–ö–æ—Ä–∑–∏–Ω–∞ üõí</button>
            <button class="menu-btn" onclick="location.href='bookmarks.html'">–ó–∞–∫–ª–∞–¥–∫–∏ üîñ</button>
            <button class="menu-btn" onclick="location.href='profile.html'">–ü—Ä–æ—Ñ–∏–ª—å üöπ</button>
        </div>
    </div>

    <script>
        document.querySelector('.logout-btn').addEventListener('click', function () {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                // –°–±—Ä–æ—Å–∏–º –∫–æ—Ä–∑–∏–Ω—É –∏ –∑–∞–∫–ª–∞–¥–∫–∏
                localStorage.removeItem('cart');
                localStorage.removeItem('bookmarks');
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                window.location.href = 'index.html';
            }
        });

        const API_BASE = `${window.location.origin}/api/v1`;
        const avatarImg = document.getElementById('avatarImg');
        const avatarInput = document.getElementById('avatarInput');

        function authHeaders() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        }

        avatarImg.addEventListener('click', () => avatarInput.click());

        // –ü–æ–¥—Ç—è–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE}/me`, { headers: authHeaders() });
                const data = await res.json();
                if (res.ok && data && data.avatar_base64) {
                    avatarImg.src = data.avatar_base64;
                }
            } catch {}
        })();

        avatarInput.addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function () {
                const base64 = reader.result;
                // –ù–µ–º–Ω–æ–≥–æ –∑–∞—â–∏—Ç–∏–º—Å—è: –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑–º–µ—Ä ~3.5 –ú–ë
                if (typeof base64 === 'string' && base64.length > 4_000_000) {
                    alert('–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/me/avatar`, {
                        method: 'PUT',
                        headers: authHeaders(),
                        body: JSON.stringify({ avatar_base64: base64 })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error((data && (data.detail || data.message)) || '–û—à–∏–±–∫–∞');
                    if (data && data.avatar_base64) {
                        avatarImg.src = data.avatar_base64;
                    }
                } catch (e) {
                    alert(e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä');
                }
            };
            reader.readAsDataURL(file);
        });

        // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
        document.querySelector('.change-pass-btn').addEventListener('click', async function () {
            const currentPassword = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:');
            if (currentPassword === null) return;
            const newPassword = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤):');
            if (newPassword === null) return;
            try {
                const res = await fetch(`${API_BASE}/me/password`, {
                    method: 'PUT',
                    headers: authHeaders(),
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å');
                }
                alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω');
            } catch (e) {
                alert(e.message || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è');
            }
        });
    </script>
</body>
</html>